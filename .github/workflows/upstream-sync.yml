name: Upstream Sync

on:
  schedule:
    # Daily at 03:00 UTC
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      upstream_repo:
        description: "Upstream repo (owner/name)"
        required: false
        default: "chatgptuk/ldc-shop"
      upstream_branch:
        description: "Upstream branch"
        required: false
        default: "main"
      mode:
        description: "sync mode: pr (safe) or push (direct to default branch)"
        required: false
        default: "pr"

permissions:
  contents: write
  pull-requests: write

env:
  DEFAULT_UPSTREAM_REPO: "chatgptuk/ldc-shop"
  DEFAULT_UPSTREAM_BRANCH: "main"

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "upstream-sync-bot"
          git config user.email "upstream-sync-bot@users.noreply.github.com"

      - name: Resolve upstream settings
        id: vars
        run: |
          UPSTREAM_REPO="${{ github.event.inputs.upstream_repo }}"
          UPSTREAM_BRANCH="${{ github.event.inputs.upstream_branch }}"
          MODE="${{ github.event.inputs.mode }}"

          if [ -z "$UPSTREAM_REPO" ]; then UPSTREAM_REPO="${DEFAULT_UPSTREAM_REPO}"; fi
          if [ -z "$UPSTREAM_BRANCH" ]; then UPSTREAM_BRANCH="${DEFAULT_UPSTREAM_BRANCH}"; fi
          if [ -z "$MODE" ]; then MODE="pr"; fi

          echo "upstream_repo=$UPSTREAM_REPO" >> "$GITHUB_OUTPUT"
          echo "upstream_branch=$UPSTREAM_BRANCH" >> "$GITHUB_OUTPUT"
          echo "mode=$MODE" >> "$GITHUB_OUTPUT"

      - name: Fetch upstream
        run: |
          git remote add upstream "https://github.com/${{ steps.vars.outputs.upstream_repo }}.git" || true
          git fetch upstream "${{ steps.vars.outputs.upstream_branch }}" --tags

      - name: Create sync branch
        run: |
          git checkout -B "upstream-sync/${{ steps.vars.outputs.upstream_branch }}"
          git merge --no-edit "upstream/${{ steps.vars.outputs.upstream_branch }}"

      - name: Push directly (optional)
        if: ${{ steps.vars.outputs.mode == 'push' }}
        run: |
          # Directly updates the default branch; will trigger Vercel if your repo is connected.
          git push origin "HEAD:${{ github.event.repository.default_branch }}"

      - name: Create pull request (default)
        if: ${{ steps.vars.outputs.mode != 'push' }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: "upstream-sync/${{ steps.vars.outputs.upstream_branch }}"
          title: "chore: upstream sync (${{ steps.vars.outputs.upstream_repo }}:${{ steps.vars.outputs.upstream_branch }})"
          body: |
            Automated upstream sync.
            - Upstream: ${{ steps.vars.outputs.upstream_repo }}
            - Branch: ${{ steps.vars.outputs.upstream_branch }}
            
            Merge this PR to trigger your normal deploy pipeline (e.g. Vercel).
          labels: |
            upstream-sync

